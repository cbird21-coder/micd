<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <title>Mic'D</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --bg: #050505; --card: #121212; --text: #d4d4d4;
            --accent: #bb86fc; --accent-dim: rgba(187,134,252,0.15);
            --danger: #cf6679; --success: #03dac6; --border: #222;
        }
        body.mode-weekend { --bg: #0c0a05; --card: #161410; --accent: #d4af37; --accent-dim: rgba(212, 175, 55, 0.15); --success: #aebc55; }
        body.mode-holiday { --bg: #020d0d; --card: #081414; --accent: #80cbc4; --accent-dim: rgba(128, 203, 196, 0.15); --success: #4db6ac; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; transition: background 0.5s ease;
        }

        /* å¼ºåŒ–å·¥ä½œé¡¹å­—ä½“ (åŠ ç²—åŠ å¤§) */
        .font-work { font-weight: 800 !important; font-size: 1.15em !important; color: #fff; letter-spacing: 0.5px; }

        /* è·‘é©¬ç¯ */
        .marquee-box { background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--border); height: 36px; flex-shrink: 0; overflow: hidden; position: relative; }
        .marquee-text { position: absolute; white-space: nowrap; line-height: 36px; color: var(--accent); font-size: 13px; letter-spacing: 1px; animation: scroll 30s linear infinite; }
        @keyframes scroll { from { left: 100%; } to { left: -100%; } }

        /* æŒ‰é’®æ ·å¼ */
        .btn { border: 1px solid #333; background: #1a1a1a; color: #888; padding: 6px 14px; border-radius: 4px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .btn-primary { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .btn-revive { border-color: #444; color: #666; font-size: 11px; padding: 4px 10px; }
        .btn-sort { padding: 2px 8px; font-size: 12px; color: #555; background: transparent; border: 1px solid #333; margin-left: 10px; border-radius: 4px; height: 24px; }
        
        /* 1. æ™¨é—´ Gateway */
        #gateway-modal { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.4s ease; }
        #gateway-modal.closed { transform: translateY(-100%); pointer-events: none; }
        .gateway-header { font-size: 18px; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-weight: bold; }
        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px 0; text-align: center; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--card); color: #666; transition: 0.3s; }
        .mode-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); font-weight: bold; transform: scale(1.02); }
        .check-section { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .select-item { display: flex; align-items: center; padding: 14px 10px; border-bottom: 1px solid var(--border); }
        .select-item.selected { background: var(--accent-dim); }
        .select-checkbox { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--accent); }
        /* æƒ©ç½šé¡¹æ ·å¼ */
        .select-item.penalty { background: rgba(207, 102, 121, 0.15); border-left: 3px solid var(--danger); pointer-events: none; }
        .select-item.penalty span { color: var(--danger); font-weight: bold; }

        /* 2. ä¸»ç•Œé¢ */
        #main-view { flex: 1; overflow-y: auto; padding: 15px 15px 180px 15px; }
        section { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 18px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        h2 { font-size: 12px; color: #666; margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .task-row { margin-bottom: 15px; padding-bottom: 5px; }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; font-weight: 500; }
        input[type=range] { width: 100%; height: 4px; accent-color: var(--accent); background: #333; border-radius: 2px; }
        .fixed-grid { display: flex; gap: 12px; margin-top: 10px; }
        .fixed-item { flex: 1; text-align: center; padding: 15px 0; background: #1a1a1a; border-radius: 8px; border: 1px solid var(--border); color: var(--success); font-size: 16px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .fixed-item.done { 
    background: transparent; color: #444; 
    text-decoration: line-through; border-color: transparent; 
    transform: scale(0.95); opacity: 0.6; 
}
.fixed-item.excess { 
    opacity: 0.15 !important; 
    filter: grayscale(1) !important;
}
        .archive-section { margin-top: 30px; border-top: 1px dashed #333; padding-top: 15px; }
        .archive-header { font-size: 12px; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 10px 0; }
        .archive-list { display: none; padding-left: 5px; }
        .archive-list.open { display: block; animation: slideDown 0.3s; }
        .archived-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; color: #555; font-size: 13px; text-decoration: line-through; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.95); border-top: 1px solid var(--border); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .progress-line { flex: 1; height: 4px; background: #222; margin-right: 20px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.5s; box-shadow: 0 0 10px var(--accent); }

        /* 3. ä»»åŠ¡æ± ç®¡ç† */
        #pool-manager { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; padding: 20px; transform: translateY(100%); transition: 0.3s; }
        #pool-manager.active { transform: translateY(0); }
        .pool-split-view { display: flex; flex: 1; gap: 15px; overflow: hidden; margin-top: 10px; }
        .pool-col { flex: 1; display: flex; flex-direction: column; background: var(--card); border-radius: 8px; padding: 10px; border: 1px solid var(--border); }
        .pool-col h3 { font-size: 12px; color: #666; margin: 0 0 10px 0; text-align: center; text-transform: uppercase; }
        .pool-scroll { flex: 1; overflow-y: auto; }
        .pool-edit-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #222; font-size: 14px; transition: background 0.2s; }
        .pool-edit-item.deleting { background: rgba(207, 102, 121, 0.2); }
        .pool-edit-item:first-of-type .btn-sort { display: none; }
        .pool-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }

        /* 4. Report Modal */
        #report-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        #report-modal.active { opacity: 1; pointer-events: auto; }
        .report-card { background: var(--card); width: 85%; max-width: 320px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); text-align: center; transform: scale(0.9); transition: 0.3s; }
        #report-modal.active .report-card { transform: scale(1); }
        .report-score { font-size: 48px; font-weight: bold; color: var(--accent); margin: 20px 0; font-family: monospace; }
        .report-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .report-streak { font-size: 12px; color: var(--success); margin-bottom: 5px; }

        /* Toast */
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(30,30,30,0.95); backdrop-filter: blur(10px); border: 1px solid var(--accent); color: var(--accent); padding: 12px 24px; border-radius: 30px; font-size: 13px; opacity: 0; pointer-events: none; transition: 0.4s; white-space: nowrap; z-index: 5000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .hidden { display: none !important; }
    </style>
</head>
<body class="mode-weekday">

    <div class="marquee-box">
        <div class="marquee-text" id="status-marquee">è‡ªå¾‹å³è‡ªç”±ã€‚</div>
    </div>
    <div id="toast"></div>

    <div id="gateway-modal">
        <div class="gateway-header">
            <span>ä»Šæ—¥å¥‘çº¦</span>
            <button class="btn" onclick="openPoolManager()" style="float:right; font-size:12px">ğŸ“š ä»»åŠ¡æ± </button>
        </div>
        <div class="mode-select">
            <div class="mode-btn active" onclick="setMode('weekday', 8, 2)" id="btn-mode-weekday">å·¥ä½œæ—¥</div>
            <div class="mode-btn" onclick="setMode('weekend', 5, 1)" id="btn-mode-weekend">åŒä¼‘æ—¥</div>
            <div class="mode-btn" onclick="setMode('holiday', 4, 1)" id="btn-mode-holiday">å‡æœŸ</div>
        </div>
        <div class="check-section">
            <div style="margin-bottom:20px">
                <h3 style="font-size:12px; color:#666; margin-bottom:10px">å·¥ä½œ (è‡³å°‘1é¡¹)</h3>
                <div id="gateway-work-list"></div>
            </div>
            <div>
                <h3 style="font-size:12px; color:#666; margin-bottom:10px">çäº‹ (è‡³å°‘<span id="req-chore">2</span>é¡¹)</h3>
                <div id="gateway-chore-list"></div>
            </div>
        </div>
        <div id="validation-msg" style="font-size:12px; color:#666; margin-bottom:10px; text-align:center">è¯·é€‰æ‹©æ¨¡å¼å¹¶å‹¾é€‰ä»»åŠ¡</div>
        <button id="btn-start" class="btn btn-primary" style="width:100%; padding:15px; font-weight:bold" disabled onclick="confirmGateway()">ğŸ”’ é”å®šå¥‘çº¦</button>
    </div>

    <div id="main-view">
        <div style="text-align:right; margin-bottom:10px;">
             <button class="btn" style="font-size:11px; color:#555; background:transparent; border:none" onclick="openPoolManager()">ğŸ“š ç»´æŠ¤ä»»åŠ¡æ± </button>
        </div>
        <section id="sec-work">
            <h2>å·¥ä½œæ‰§è¡Œ</h2>
            <div id="main-work-list"></div>
            <div id="empty-work" class="hidden" style="text-align:center; color:#333; font-size:12px; padding:10px">å·¥ä½œå·²å®Œæˆ</div>
        </section>
        <section id="sec-chore">
            <h2>å¾…åŠçäº‹</h2>
            <div id="main-chore-list"></div>
            <div id="empty-chore" class="hidden" style="text-align:center; color:#333; font-size:12px; padding:10px">çäº‹å·²æ¸…ç©º</div>
        </section>
        <section>
            <h2>æ¯æ—¥åŸºçŸ³ (3é€‰2)</h2>
            <div class="fixed-grid">
                <div class="fixed-item" id="f-read" onclick="toggleFixed('read')">ğŸ“– è¯»å†™</div>
                <div class="fixed-item" id="f-clean" onclick="toggleFixed('clean')">ğŸš¿ æ•´æ´—</div>
                <div class="fixed-item" id="f-meditate" onclick="toggleFixed('meditate')">ğŸ§˜ ç»ƒæƒ³</div>
            </div>
        </section>
        <div class="archive-section">
            <div class="archive-header" onclick="toggleArchive()">
                <span>â–¼ å·²å½’æ¡£ / å·²å®Œæˆ (<span id="archive-count">0</span>)</span>
            </div>
            <div class="archive-list" id="archive-container"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="progress-line"><div class="progress-fill" id="progress-bar"></div></div>
        <div style="display:flex; gap:10px">
            <button class="btn" onclick="openReportModal()">å‘¨æŠ¥</button>
            <button class="btn" id="btn-giveup" style="color:var(--danger); border-color:#333; min-width:60px" onclick="handleStopLoss()">æ­¢æŸ</button>
        </div>
    </div>

    <div id="pool-manager">
        <div class="gateway-header">
            <span>ä»»åŠ¡æ±  (é•¿æŒ‰åˆ é™¤)</span>
            <button class="btn" onclick="closePoolManager()" style="float:right">å®Œæˆ</button>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <input type="text" id="pool-name" placeholder="è¾“å…¥åç§°..." style="flex:1; background:#222; border:none; padding:10px; color:#fff; border-radius:4px">
            <div style="display:flex; gap:5px">
                <button class="btn" onclick="addPoolItem('work')">+å·¥ä½œ</button>
                <button class="btn" onclick="addPoolItem('chore')">+çäº‹</button>
            </div>
        </div>
        <div class="pool-split-view">
            <div class="pool-col">
                <h3>å·¥ä½œåº“</h3>
                <div class="pool-scroll" id="pool-col-work"></div>
            </div>
            <div class="pool-col">
                <h3>çäº‹åº“</h3>
                <div class="pool-scroll" id="pool-col-chore"></div>
            </div>
        </div>
    </div>

    <div id="report-modal" onclick="closeReportModal(event)">
        <div class="report-card">
            <div class="report-streak" id="streak-display"></div>
            <div style="color:#666; font-size:12px; text-transform:uppercase; letter-spacing:1px">ä»Šæ—¥å®Œæˆç‡</div>
            <div class="report-score" id="report-score-val">0%</div>
            <div style="font-size:12px; color:#888" id="report-msg">ä¿æŒèŠ‚å¥</div>
            <div class="report-btn-group">
                <button class="btn btn-primary" style="padding:12px" onclick="enterJudgment()">ğŸ”¥ è¿›å…¥è£å†³ (ä»…å‘¨æ—¥)</button>
                <button class="btn" style="padding:12px; border:none" onclick="document.getElementById('report-modal').classList.remove('active')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = 'discipline_v12';
        const DB_VERSION = 1;

        // Punishments for <60%
        const PENALTIES = ["è·‘æ­¥15åˆ†é’Ÿ", "è”ç³»ä¸€ä½è€å‹", "å°è¯•ä¸€ä»½æ–°èœè°±", "æ·±è¹²50ä¸ª", "æ•´ç†ç›¸å†Œ30åˆ†é’Ÿ", "ä¸çœ‹æ‰‹æœº1å°æ—¶", "å†™300å­—æ—¥è®°"];
        
        const QUOTES = {
            daily: ["è‡ªå¾‹æ˜¯åæŠ—ç†µå¢çš„å”¯ä¸€æ‰‹æ®µã€‚", "è¾“å…¥å†³å®šè¾“å‡ºï¼Œä½ æ­£åœ¨æ„å»ºä½ çš„å¤§è„‘ã€‚", "ä¸è¦å‡è£…åŠªåŠ›ï¼Œç»“æœä¸ä¼šé™ªä½ æ¼”æˆã€‚", "ä¸€å±‹ä¸æ‰«ï¼Œä½•ä»¥æ‰«å¤©ä¸‹ã€‚", "åŠ¨ä½œæ˜¯ç„¦è™‘çš„è§£è¯ã€‚", "çŸ¥è¡Œåˆä¸€ã€‚", "æ…ç‹¬ã€‚", "ä½ ä¸æ˜¯è¢«æƒ…ç»ªæ¨ç€èµ°çš„äººã€‚", "è‡ªç”±å³è´£ä»»ã€‚", "å‘å†…è§‚çœ‹ï¼Œä¸–ç•Œå®‰é™ã€‚", "ä¸è¦æ¸©å’Œåœ°èµ°è¿›é‚£ä¸ªè‰¯å¤œã€‚", "å‡¡å¢™çš†æ˜¯é—¨ã€‚", "çœŸæ­£çš„å¹³é™ï¼Œä¸æ˜¯é¿å¼€è½¦é©¬å–§åš£ã€‚", "æµæ°´ä¸äº‰å…ˆï¼Œäº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€‚", "æ—¥æ‹±ä¸€å’ï¼ŒåŠŸä¸å”æã€‚", "ä¸‡ç‰©çš†æœ‰è£‚ç—•ï¼Œé‚£æ˜¯å…‰ç…§è¿›æ¥çš„åœ°æ–¹ã€‚", "æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©ã€‚", "æ­¤åˆ»ï¼Œä¸“æ³¨å½“ä¸‹ã€‚"],
            cornerstone: { read: ["ä¹¦å·å¤šæƒ…ä¼¼æ•…äººã€‚", "ç²¾ç¥é¿éš¾æ‰€å·²å»ºç«‹ã€‚", "è¿™ä¸€åˆ»ï¼Œä½ ä¸å¤äººå¯¹è¯ã€‚"], clean: ["æ‰«é™¤æ˜¯å†…å¿ƒçš„æ²æµ´ã€‚", "ç§©åºäº§ç”Ÿå¹³é™ã€‚", "ä¸€å°˜ä¸æŸ“ï¼Œä¸‡å¿µå½’ä¸€ã€‚"], meditate: ["å‘å†…è§‚çœ‹ã€‚", "æ­¤åˆ»ï¼Œä¸–ç•Œé™éŸ³ã€‚", "é™èƒ½ç”Ÿæ…§ã€‚"] },
            work: ["è¡Œèƒœäºè¨€ã€‚", "ä¸“æ³¨å³åŠ›é‡ã€‚", "è¿™æ˜¯ä½ ä¸å¹³åº¸çš„è·ç¦»ã€‚", "å¹²å¾—æ¼‚äº®ï¼Œç»§ç»­ã€‚", "ä¸è¦åœï¼Œä¿æŒèŠ‚å¥ã€‚"],
            chore: ["ç”Ÿæ´»åœ¨ç»†èŠ‚ä¸­ã€‚", "æ¸…ç©ºå¤§è„‘ç¼“å­˜ã€‚", "å°äº‹æˆå°±ç§©åºã€‚", "æ‹’ç»æ‹–å»¶ã€‚", "è§£å†³æ‰å®ƒï¼Œçˆ½ã€‚"],
            roast: ["ä½ çš„é›„å¿ƒé…ä¸ä¸Šä½ çš„æ‡’æƒ°ã€‚", "é—´æ­‡æ€§è¸Œèº‡æ»¡å¿—ï¼ŒæŒç»­æ€§æ··åƒç­‰æ­»ã€‚", "è®¡åˆ’æ˜¯è‡ªæ¬ºæ¬ºäººçš„è°è¨€å—ï¼Ÿ", "ä½ æ­£åœ¨æ¸©æ°´é‡Œæ…¢æ…¢è…çƒ‚ã€‚", "ä»Šå¤©çš„ä½ ï¼Œé…ä¸ä¸Šæ˜å¤©çš„æ¢¦æƒ³ã€‚"]
        };

        let db = {
            meta: { version: 1, lastDate: '', mode: 'weekday', target: 8, reqChores: 2, todayQuote: '', streak: 0, pendingPenalty: null },
            pool: { work: [{id:'w1', name:'æ·±åº¦å·¥ä½œ'}, {id:'w2', name:'ä¼šè®®'}], chore: [{id:'c1', name:'æ¸…ç†æ¡Œé¢'}, {id:'c2', name:'å›å¤æ¶ˆæ¯'}] },
            today: { work: [], chores: [], fixed: {read:false, clean:false, meditate:false}, givenUp: false, stopLossStart: 0 },
            history: {}, setupComplete: false
        };
        let tempSel = { workIds: new Set(), choreIds: new Set() };
        let stopLossTimer = null, pressTimer = null;

        window.onload = () => {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                if(!parsed.meta.version) localStorage.removeItem(DB_KEY);
                else db = parsed;
            }
            checkNewDay();
            document.getElementById('status-marquee').innerText = db.meta.todayQuote || "è‡ªå¾‹å³è‡ªç”±ã€‚";
            applyTheme(db.meta.mode);
            if(!db.setupComplete) initGateway();
            else { document.getElementById('gateway-modal').classList.add('closed'); renderMain(); if(db.today.stopLossStart > 0) startStopLossTimer(); }

            // Register SW
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("sw.js").catch(err => console.log(err));
            }
        };

        function checkNewDay() {
            const nowStr = new Date().toLocaleDateString();
            if(db.meta.lastDate !== nowStr) {
                if (db.meta.lastDate) {
                    const yesterdayScore = calculateScore();
                    const yesterdayRate = yesterdayScore / db.meta.target;
                    db.history[db.meta.lastDate] = { score: yesterdayScore, rate: yesterdayRate, givenUp: db.today.givenUp };
                    if (yesterdayRate >= 0.6 && !db.today.givenUp) db.meta.streak = (db.meta.streak || 0) + 1;
                    else db.meta.streak = 0;
                    if (yesterdayRate < 0.6 || db.today.givenUp) db.meta.pendingPenalty = PENALTIES[Math.floor(Math.random() * PENALTIES.length)];
                    else db.meta.pendingPenalty = null;
                }
                db.meta.lastDate = nowStr;
                db.meta.todayQuote = QUOTES.daily[Math.floor(Math.random() * QUOTES.daily.length)];
                db.today = { work: [], chores: [], fixed: {read:false, clean:false, meditate:false}, givenUp: false, stopLossStart: 0 };
                db.setupComplete = false;
                saveDB();
            }
        }

        function setMode(mode, target, req) { db.meta.mode=mode; db.meta.target=target; db.meta.reqChores=req; applyTheme(mode); document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-mode-${mode}`).classList.add('active'); document.getElementById('req-chore').innerText = req; validateGateway(); }
        function applyTheme(mode) { document.body.className = `mode-${mode}`; }

        function initGateway() { setMode(db.meta.mode, db.meta.target, db.meta.reqChores); renderGatewayList(); validateGateway(); }
        function renderGatewayList() {
            let htmlWork = '', htmlChore = '';
            if (db.meta.pendingPenalty) htmlChore += `<div class="select-item penalty"><input type="checkbox" class="select-checkbox" checked disabled><span>âš ï¸ æƒ©ç½šï¼š${db.meta.pendingPenalty}</span></div>`;
            const mkItem = (item, type, set) => `
                <div class="select-item ${set.has(item.id)?'selected':''}" onclick="toggleSel('${type}', '${item.id}', this)">
                    <input type="checkbox" class="select-checkbox" ${set.has(item.id)?'checked':''}>
                    <span class="${type==='work'?'font-work':''}">${item.name}</span>
                </div>`;
            htmlWork += db.pool.work.map(i => mkItem(i, 'work', tempSel.workIds)).join('');
            htmlChore += db.pool.chore.map(i => mkItem(i, 'chore', tempSel.choreIds)).join('');
            document.getElementById('gateway-work-list').innerHTML = htmlWork;
            document.getElementById('gateway-chore-list').innerHTML = htmlChore;
        }
        function toggleSel(type, id, el) { const set = type === 'work' ? tempSel.workIds : tempSel.choreIds; if(set.has(id)) { set.delete(id); el.classList.remove('selected'); el.querySelector('input').checked = false; } else { set.add(id); el.classList.add('selected'); el.querySelector('input').checked = true; } validateGateway(); }
        function validateGateway() { const valid = tempSel.workIds.size >= 1 && tempSel.choreIds.size >= db.meta.reqChores; const btn = document.getElementById('btn-start'); btn.disabled = !valid; btn.style.opacity = valid ? 1 : 0.5; document.getElementById('validation-msg').innerText = valid ? "âœ“ å¥‘çº¦åˆè§„" : `éœ€è‡³å°‘ 1 å·¥ä½œ + ${db.meta.reqChores} çäº‹`; document.getElementById('validation-msg').style.color = valid ? "var(--success)" : "#666"; }
        function confirmGateway() { 
            db.today.work = db.pool.work.filter(i => tempSel.workIds.has(i.id)).map(i => ({...i, val:0, done:false})); 
            db.today.chores = db.pool.chore.filter(i => tempSel.choreIds.has(i.id)).map(i => ({...i, done:false})); 
            if (db.meta.pendingPenalty) { db.today.chores.unshift({ id: 'penalty-'+Date.now(), name: "âš ï¸ " + db.meta.pendingPenalty, done: false, isPenalty: true }); db.meta.pendingPenalty = null; }
            db.setupComplete = true; saveDB(); document.getElementById('gateway-modal').classList.add('closed'); renderMain(); 
        }

        function renderMain() {
            if(db.today.givenUp) document.body.style.filter = "grayscale(1)";
            const activeWork = db.today.work.filter(w => !w.done);
            const activeChore = db.today.chores.filter(c => !c.done);
            const doneWork = db.today.work.filter(w => w.done);
            const doneChore = db.today.chores.filter(c => c.done);

            document.getElementById('main-work-list').innerHTML = activeWork.map(w => `
                <div class="task-row work-task">
                    <div class="task-header"><span class="font-work">${w.name}</span><span id="v-${w.id}">${w.val}h</span></div>
                    <div style="display:flex; align-items:center; gap:10px">
                        <input type="range" min="0" max="5" step="0.5" value="${w.val}" oninput="document.getElementById('v-${w.id}').innerText=this.value+'h'" onchange="updateWorkVal('${w.id}', this.value)"> 
                        <button class="btn btn-primary" onclick="doWork('${w.id}', this)">Done</button>
                    </div>
                </div>`).join('');
            document.getElementById('empty-work').classList.toggle('hidden', activeWork.length > 0);

            document.getElementById('main-chore-list').innerHTML = activeChore.map(c => `
                <div class="task-row" style="display:flex; justify-content:space-between; align-items:center">
                    <span class="${c.isPenalty ? 'font-work' : ''}" style="${c.isPenalty ? 'color:var(--danger)' : ''}">${c.name}</span>
                    <button class="btn btn-primary" onclick="doChore('${c.id}')">Done</button>
                </div>`).join('');
            document.getElementById('empty-chore').classList.toggle('hidden', activeChore.length > 0);

            document.getElementById('archive-count').innerText = doneWork.length + doneChore.length;
            document.getElementById('archive-container').innerHTML = `
                ${doneWork.map(w => `<div class="archived-item"><span class="font-work">ğŸ’¼ ${w.name} (${w.val}h)</span><button class="btn btn-revive" onclick="revive('work', '${w.id}')">æ’¤é”€</button></div>`).join('')}
                ${doneChore.map(c => `<div class="archived-item"><span>ğŸ“ ${c.name}</span><button class="btn btn-revive" onclick="revive('chore', '${c.id}')">æ’¤é”€</button></div>`).join('')}`;
            renderFixed(); updateProgress();
        }
        
        function updateWorkVal(id, val) { const item = db.today.work.find(i => i.id === id); if(item) { item.val = parseFloat(val); saveDB(); } }
        function doWork(id, btn) { const val = parseFloat(btn.previousElementSibling.value); if(val < 0.5) return alert("å·¥ä½œéœ€ >= 0.5h"); updateWorkVal(id, val); db.today.work.find(i => i.id === id).done = true; pickToast(QUOTES.work); saveAndRender(); }
        function doChore(id) { db.today.chores.find(i => i.id === id).done = true; pickToast(QUOTES.chore); saveAndRender(); }
        function revive(type, id) { if(type==='work') db.today.work.find(i => i.id === id).done = false; else db.today.chores.find(i => i.id === id).done = false; saveAndRender(); }
        function toggleFixed(key) { if(db.today.givenUp) return; const wasFalse = !db.today.fixed[key]; db.today.fixed[key] = !db.today.fixed[key]; saveAndRender(); if (wasFalse) pickToast(QUOTES.cornerstone[key]); }
       // --- æ ¸å¿ƒï¼šè®¡åˆ†å°é¡¶ç®—æ³• ---
function calculateScore() {
    let s = 0;
    const mode = db.meta.mode;
    
    // å®šä¹‰å„æ¨¡å¼ä¸‹çš„æƒé‡ä¸Šé™
    const workTarget = (mode === 'weekday') ? 4 : (mode === 'weekend' ? 2 : 1);
    const choreTarget = (mode === 'weekday') ? 2 : 1;
    const fixedTarget = 2; // å›ºå®šé¡¹å§‹ç»ˆæ‰§è¡Œ 3é€‰2 æƒé‡å°é¡¶

    // 1. å·¥ä½œå¾—åˆ†å°é¡¶
    const actualWork = db.today.work.filter(w => w.done).reduce((a, b) => a + b.val, 0);
    s += Math.min(actualWork, workTarget);

    // 2. çäº‹å¾—åˆ†å°é¡¶
    const actualChores = db.today.chores.filter(c => c.done).length;
    s += Math.min(actualChores, choreTarget);

    // 3. å›ºå®šé¡¹å¾—åˆ†å°é¡¶
    const actualFixed = Object.values(db.today.fixed).filter(v => v).length;
    s += Math.min(actualFixed, fixedTarget);

    return s;
}

// --- æ ¸å¿ƒï¼šå›ºå®šé¡¹è§†è§‰å‘ˆç°é€»è¾‘ ---
function renderFixed() {
    const f = db.today.fixed;
    // è®¡ç®—å·²å®Œæˆçš„æ•°é‡
    const count = Object.values(f).filter(v => v).length;

    ['read','clean','meditate'].forEach(k => {
        const el = document.getElementById('f-' + k);
        // å…ˆé‡ç½®æ ·å¼ç±»
        el.className = 'fixed-item';
        
        // å¦‚æœè¯¥é¡¹å·²å®Œæˆ
        if(f[k]) {
            el.classList.add('done');
        } 
        // æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœå·²å®Œæˆæ»¡ 2 é¡¹ï¼Œä¸”å½“å‰é¡¹æœªå®Œæˆï¼Œåˆ™åº”ç”¨æåº¦é€æ˜æ ·å¼
        else if(count >= 2) {
            el.classList.add('excess');
        }
    });
}
        function updateProgress() { const pct = Math.min((calculateScore() / db.meta.target) * 100, 100); document.getElementById('progress-bar').style.width = pct + '%'; }
        
        function handleStopLoss() {
            if (db.today.givenUp) return;
            const btn = document.getElementById('btn-giveup');
            if (db.today.stopLossStart === 0) { db.today.stopLossStart = Date.now(); saveDB(); startStopLossTimer(); return; }
            if (Date.now() - db.today.stopLossStart < 30 * 60 * 1000) { if(confirm("æ’¤é”€â€œæ­¢æŸâ€ï¼Ÿ")) { db.today.stopLossStart = 0; saveDB(); clearInterval(stopLossTimer); btn.innerText = "æ­¢æŸ"; btn.style.borderColor = "#333"; btn.style.color = "var(--danger)"; } return; }
            if(confirm("ç¡®è®¤æ”¾å¼ƒä»Šæ—¥ï¼Ÿ\nä½ é€‰æ‹©äº†èƒŒå›ã€‚")) { db.today.givenUp = true; db.today.stopLossStart = 0; clearInterval(stopLossTimer); saveAndRender(); }
        }
        function startStopLossTimer() {
            const btn = document.getElementById('btn-giveup');
            stopLossTimer = setInterval(() => { const remaining = 30 * 60 * 1000 - (Date.now() - db.today.stopLossStart); if (remaining > 0) { const mm = Math.floor(remaining / 60000); const ss = Math.floor((remaining % 60000) / 1000); btn.innerText = `æ’¤é”€ (${mm}:${ss<10?'0'+ss:ss})`; btn.style.color = "#888"; btn.style.borderColor = "#888"; } else { btn.innerText = "ç¡®è®¤æ”¾å¼ƒ"; btn.style.color = "var(--danger)"; btn.style.borderColor = "var(--danger)"; } }, 1000);
        }

        function openPoolManager() { renderPoolCols(); document.getElementById('pool-manager').classList.add('active'); }
        function closePoolManager() { document.getElementById('pool-manager').classList.remove('active'); if(!db.setupComplete) renderGatewayList(); }
        function renderPoolCols() {
            const mkHtml = (type) => db.pool[type].map((i, idx) => `
                <div class="pool-edit-item" 
                     ontouchstart="startPress('${type}', '${i.id}', this)" ontouchend="cancelPress()" 
                     onmousedown="startPress('${type}', '${i.id}', this)" onmouseup="cancelPress()" oncontextmenu="return false;">
                    <div class="pool-text ${type==='work'?'font-work':''}">${i.name}</div>
                    <button class="btn-sort" onclick="moveItem('${type}', ${idx}, -1)">â†‘</button>
                </div>`).join('');
            document.getElementById('pool-col-work').innerHTML = mkHtml('work');
            document.getElementById('pool-col-chore').innerHTML = mkHtml('chore');
        }
        function moveItem(type, index, direction) { const arr = db.pool[type]; const newIndex = index + direction; if (newIndex >= 0) { [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]]; saveDB(); renderPoolCols(); } }
        function startPress(type, id, el) { pressTimer = setTimeout(() => { if(navigator.vibrate) navigator.vibrate(50); el.classList.add('deleting'); if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) delPool(type, id); el.classList.remove('deleting'); }, 800); }
        function cancelPress() { clearTimeout(pressTimer); }
        function addPoolItem(type) { const name = document.getElementById('pool-name').value.trim(); if(name) { db.pool[type].push({id: type[0]+Date.now(), name}); document.getElementById('pool-name').value = ''; saveDB(); renderPoolCols(); } }
        function delPool(type, id) { db.pool[type] = db.pool[type].filter(i=>i.id!==id); saveDB(); renderPoolCols(); }

        function openReportModal() {
            const rate = calculateScore() / db.meta.target;
            document.getElementById('report-score-val').innerText = Math.round(rate * 100) + '%';
            document.getElementById('report-msg').innerText = rate >= 1 ? "ä»Šæ—¥å·²å®Œç¾" : "ç»§ç»­ä¿æŒèŠ‚å¥";
            const s = db.meta.streak || 0;
            const sEl = document.getElementById('streak-display');
            if (s > 1) { sEl.innerText = `ğŸ”¥ è¿ç»­è¾¾æˆ ${s} å¤©`; sEl.style.display = 'block'; }
            else { sEl.style.display = 'none'; }
            document.getElementById('report-modal').classList.add('active');
        }
        function closeReportModal(e) { if(e.target.id === 'report-modal') document.getElementById('report-modal').classList.remove('active'); }
        function enterJudgment() {
            const day = new Date().getDay();
            if (day !== 0) return alert("ğŸš« è£å†³æ—¥æœªåˆ°ï¼ˆä»…å‘¨æ—¥å¼€å¯ï¼‰ã€‚");
            const rate = calculateScore() / db.meta.target;
            let msg = `ğŸ“Š å®¡åˆ¤å‘¨æŠ¥\n\næœ¬å‘¨å¹³å‡ï¼š${Math.round(rate*100)}% (æ¨¡æ‹Ÿ)\n\n`;
            if (rate < 0.6) msg += `âš ï¸ è£å†³ï¼š\nâ€œ${QUOTES.roast[Math.floor(Math.random() * QUOTES.roast.length)]}â€`;
            else msg += `âœ… è£å†³ï¼š\nâ€œä½ æŒæ§äº†è‡ªå·±ï¼Œä¹Ÿå°±æŒæ§äº†è‡ªç”±ã€‚â€`;
            alert(msg);
        }

        function pickToast(arr) { const t = document.getElementById('toast'); t.innerText = arr[Math.floor(Math.random() * arr.length)]; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function toggleArchive() { document.getElementById('archive-container').classList.toggle('open'); }
        function saveAndRender() { saveDB(); renderMain(); }
        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    </script>
</body>
</html>