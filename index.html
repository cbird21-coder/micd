<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <title>Mic'D</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --bg: #050505; --card: #121212; --text: #d4d4d4;
            --accent: #bb86fc; --accent-dim: rgba(187,134,252,0.15);
            --danger: #cf6679; --success: #03dac6; --border: #222;
        }
        body.mode-weekend { --bg: #0c0a05; --card: #161410; --accent: #d4af37; --accent-dim: rgba(212, 175, 55, 0.15); --success: #aebc55; }
        body.mode-holiday { --bg: #020d0d; --card: #081414; --accent: #80cbc4; --accent-dim: rgba(128, 203, 196, 0.15); --success: #4db6ac; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.5s ease; }

        .font-work { font-weight: 800 !important; font-size: 1.15em !important; color: #fff; letter-spacing: 0.5px; }
        .marquee-box { background: rgba(0,0,0,0.6); border-bottom: 1px solid var(--border); height: 36px; flex-shrink: 0; overflow: hidden; position: relative; }
        .marquee-text { position: absolute; white-space: nowrap; line-height: 36px; color: var(--accent); font-size: 13px; letter-spacing: 1px; animation: scroll 30s linear infinite; }
        @keyframes scroll { from { left: 100%; } to { left: -100%; } }

        /* Buttons */
        .btn { border: 1px solid #333; background: #1a1a1a; color: #888; padding: 6px 14px; border-radius: 4px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .btn-primary { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .btn-revive { border-color: #444; color: #666; font-size: 11px; padding: 4px 10px; }
        .btn-sort { padding: 4px 12px; font-size: 14px; color: #555; background: transparent; border: 1px solid #333; margin-left: 10px; border-radius: 4px; }
        .btn-icon { background: transparent; border: none; padding: 5px; cursor: pointer; display: flex; align-items: center; }

        /* --- æ ¸å¿ƒå‡çº§ï¼šè‡ªå®šä¹‰æ»‘å—æ ·å¼ --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0;
        }
        input[type=range]:focus { outline: none; }
        
        /* æ»‘å—è½¨é“ï¼šæ··åˆå›¾å±‚å®ç°å¡«å……å’Œåˆ»åº¦ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 10px; cursor: pointer; border-radius: 5px;
            border: 1px solid #333;
            /* å›¾å±‚1(ä¸Š): é»‘è‰²åˆ»åº¦çº¿ï¼Œæ¯12.5% (0.5/4) ä¸€æ¡ */
            /* å›¾å±‚2(ä¸‹): åŠ¨æ€è¿›åº¦æ¡ï¼Œå·¦è¾¹æ˜¯ä¸»é¢˜è‰²ï¼Œå³è¾¹æ˜¯æ·±ç° */
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent calc(12.5% - 1px), #000 calc(12.5% - 1px), #000 12.5%),
                linear-gradient(90deg, var(--accent) var(--pct), #222 var(--pct));
        }
        
        /* æ»‘å—åœ†é’® */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px;
            border-radius: 50%; background: #fff; 
            border: 2px solid var(--accent);
            margin-top: -5px; /* å‚ç›´å±…ä¸­ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }

        /* Gateway Modal */
        #gateway-modal { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; padding: 20px; transition: transform 0.4s ease; }
        #gateway-modal.closed { transform: translateY(-100%); pointer-events: none; }
        .gateway-header { font-size: 18px; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .mode-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px 0; text-align: center; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: var(--card); color: #666; transition: 0.3s; }
        .mode-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); font-weight: bold; transform: scale(1.02); }
        .check-section { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .select-item { display: flex; align-items: center; padding: 14px 10px; border-bottom: 1px solid var(--border); }
        .select-item.selected { background: var(--accent-dim); }
        .select-checkbox { width: 18px; height: 18px; margin-right: 12px; accent-color: var(--accent); }
        .select-item.penalty { background: rgba(207, 102, 121, 0.15); border-left: 3px solid var(--danger); pointer-events: none; }
        .select-item.penalty span { color: var(--danger); font-weight: bold; }

        /* Main View */
        #main-view { flex: 1; overflow-y: auto; padding: 15px 15px 180px 15px; }
        section { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 18px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        h2 { font-size: 12px; color: #666; margin: 0 0 15px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .task-row { margin-bottom: 15px; padding-bottom: 5px; }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; font-weight: 500; }
        
        .fixed-grid { display: flex; gap: 12px; margin-top: 10px; }
        .fixed-item { flex: 1; text-align: center; padding: 15px 0; background: #1a1a1a; border-radius: 8px; border: 1px solid var(--border); color: var(--success); font-size: 16px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .fixed-item.done { background: transparent; color: #444; text-decoration: line-through; border-color: transparent; transform: scale(0.95); opacity: 0.6; }
        .fixed-item.excess { opacity: 0.15 !important; filter: grayscale(1) !important; }

        .archive-section { margin-top: 30px; border-top: 1px dashed #333; padding-top: 15px; }
        .archive-header { font-size: 12px; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; padding: 10px 0; }
        .archive-list { display: none; padding-left: 5px; }
        .archive-list.open { display: block; animation: slideDown 0.3s; }
        .archived-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; color: #555; font-size: 13px; text-decoration: line-through; }

        /* Nav */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.95); border-top: 1px solid var(--border); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .progress-line { flex: 1; height: 4px; background: #222; margin-right: 20px; border-radius: 2px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.5s; box-shadow: 0 0 10px var(--accent); }

        /* Task Pool */
        #pool-modal { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        #pool-modal.active { transform: translateY(0); }
        .pool-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pool-content { flex: 1; overflow-y: auto; padding: 15px; }
        .pool-tabs { display: flex; border-top: 1px solid var(--border); background: var(--card); }
        .pool-tab { flex: 1; padding: 15px; text-align: center; color: #666; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .pool-tab.active { color: var(--accent); font-weight: bold; background: rgba(255,255,255,0.05); border-top: 2px solid var(--accent); }
        .pool-item-row { display: flex; align-items: center; padding: 12px 5px; border-bottom: 1px solid #222; font-size: 15px; }
        .pool-text { flex: 1; margin-left: 10px; } 
        
        .hidden-section { margin-top: 20px; border-top: 1px dashed #333; }
        .hidden-toggle { color: #666; font-size: 12px; padding: 15px; text-align: center; cursor: pointer; }
        .hidden-list { display: none; background: #0f0f0f; }
        .hidden-list.open { display: block; }
        .pool-item-row.hidden-item { opacity: 0.6; color: #666; }
        .pool-item-row.hidden-item .pool-text { text-decoration: line-through; }

        /* Action Sheet */
        #action-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-radius: 16px 16px 0 0; z-index: 5000; transform: translateY(100%); transition: 0.3s; padding: 20px; border-top: 1px solid var(--border); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        #action-sheet.active { transform: translateY(0); }
        .sheet-title { text-align: center; color: #888; font-size: 13px; margin-bottom: 20px; }
        .sheet-btn { width: 100%; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 16px; font-weight: bold; border: none; cursor: pointer; }
        .btn-rename { background: var(--accent-dim); color: var(--accent); }
        .btn-delete { background: var(--danger); color: #fff; }
        .btn-cancel { background: transparent; color: #666; border: 1px solid #333; }
        #sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 4999; display: none; }
        #sheet-overlay.active { display: block; }

        /* Data Modal */
        #data-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        #data-modal.active { opacity: 1; pointer-events: auto; }
        .data-card { background: var(--card); width: 85%; max-width: 320px; padding: 25px; border-radius: 16px; border: 1px solid var(--border); text-align: center; max-height: 80vh; overflow-y: auto; }
        .data-score { font-size: 56px; font-weight: bold; color: var(--accent); margin: 15px 0; font-family: monospace; }
        .history-chart { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; display: none; text-align: left; }
        .history-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #888; }
        .bar-bg { width: 100px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); }
        .roast-text { margin-top: 15px; font-size: 12px; color: var(--danger); font-style: italic; text-align: center; border: 1px dashed #333; padding: 10px; border-radius: 6px; }

        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(30,30,30,0.95); backdrop-filter: blur(10px); border: 1px solid var(--accent); color: var(--accent); padding: 12px 24px; border-radius: 30px; font-size: 13px; opacity: 0; pointer-events: none; transition: 0.4s; white-space: nowrap; z-index: 5000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="mode-weekday">

    <div class="marquee-box">
        <div class="marquee-text" id="status-marquee">è‡ªå¾‹å³è‡ªç”±ã€‚</div>
    </div>
    <div id="toast"></div>

    <div id="gateway-modal">
        <div class="gateway-header">
            <span>ä»Šæ—¥å¥‘çº¦</span>
            <button class="btn" style="padding:4px 10px; font-size:12px; border-color:#444;" onclick="openPoolModal()">âš™ï¸ ä»»åŠ¡æ± </button>
        </div>
        <div class="mode-select">
            <div class="mode-btn" onclick="checkModeSelection('weekday')" id="btn-mode-weekday">å·¥ä½œæ—¥</div>
            <div class="mode-btn" onclick="checkModeSelection('weekend')" id="btn-mode-weekend">åŒä¼‘æ—¥</div>
            <div class="mode-btn" onclick="checkModeSelection('holiday')" id="btn-mode-holiday">å‡æœŸ</div>
        </div>
        <div class="check-section">
            <div style="margin-bottom:20px">
                <h3 style="font-size:12px; color:#666; margin-bottom:10px">å·¥ä½œ (è‡³å°‘1é¡¹)</h3>
                <div id="gateway-work-list"></div>
            </div>
            <div>
                <h3 style="font-size:12px; color:#666; margin-bottom:10px">çäº‹ (è‡³å°‘<span id="req-chore">2</span>é¡¹)</h3>
                <div id="gateway-chore-list"></div>
            </div>
        </div>
        <button id="btn-start" class="btn btn-primary" style="width:100%; padding:15px; font-weight:bold" disabled onclick="confirmGateway()">ğŸ”’ é”å®šå¥‘çº¦</button>
    </div>

    <div id="main-view">
        <div style="text-align:right; margin-bottom:10px;">
             <button class="btn" style="font-size:11px; color:#555; background:transparent; border:none" onclick="openPoolModal()">âš™ï¸ ä»»åŠ¡æ± </button>
        </div>

        <section id="sec-work">
            <h2>å·¥ä½œæ‰§è¡Œ</h2>
            <div id="main-work-list"></div>
            <div id="empty-work" class="hidden" style="text-align:center; color:#333; font-size:12px; padding:10px">å·¥ä½œå·²å®Œæˆ</div>
        </section>
        <section id="sec-chore">
            <h2>å¾…åŠçäº‹</h2>
            <div id="main-chore-list"></div>
            <div id="empty-chore" class="hidden" style="text-align:center; color:#333; font-size:12px; padding:10px">çäº‹å·²æ¸…ç©º</div>
        </section>
        <section>
            <h2>æ¯æ—¥åŸºçŸ³ (3é€‰2)</h2>
            <div class="fixed-grid">
                <div class="fixed-item" id="f-read" onclick="toggleFixed('read')">ğŸ“– è¯»å†™</div>
                <div class="fixed-item" id="f-clean" onclick="toggleFixed('clean')">ğŸš¿ æ•´æ´—</div>
                <div class="fixed-item" id="f-meditate" onclick="toggleFixed('meditate')">ğŸ§˜ ç»ƒæƒ³</div>
            </div>
        </section>
        
        <div class="archive-section">
            <div class="archive-header" onclick="toggleArchive()">
                <span>â–¼ å·²å½’æ¡£ / å·²å®Œæˆ (<span id="archive-count">0</span>)</span>
            </div>
            <div class="archive-list" id="archive-container"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="progress-line"><div class="progress-fill" id="progress-bar"></div></div>
        <div style="display:flex; gap:10px">
            <button class="btn" onclick="openDataModal()">æ•°æ®</button>
            <button class="btn" id="btn-giveup" style="color:var(--danger); border-color:#333; min-width:60px" onclick="handleStopLoss()">æ­¢æŸ</button>
        </div>
    </div>

    <div id="pool-modal">
        <div class="pool-header">
            <span>ä»»åŠ¡æ± ç®¡ç†</span>
            <button class="btn" onclick="closePoolModal()">å®Œæˆ</button>
        </div>
        <div style="padding:10px 15px; border-bottom:1px solid #222; display:flex; gap:10px;">
            <input type="text" id="pool-input" placeholder="è¾“å…¥æ–°ä»»åŠ¡..." style="flex:1; background:#222; border:none; padding:12px; color:#fff; border-radius:6px; outline:none;" onkeypress="if(event.keyCode==13) addNewToPool()">
            <button class="btn btn-primary" onclick="addNewToPool()">æ·»åŠ </button>
        </div>
        <div class="pool-content" id="pool-list-container"></div>
        <div class="pool-tabs">
            <div class="pool-tab active" onclick="switchPoolTab('work')" id="tab-work">å·¥ä½œåº“</div>
            <div class="pool-tab" onclick="switchPoolTab('chore')" id="tab-chore">çäº‹åº“</div>
        </div>
    </div>

    <div id="sheet-overlay" onclick="closeActionSheet()"></div>
    <div id="action-sheet">
        <div class="sheet-title" id="sheet-msg">æ“ä½œé€‰é¡¹</div>
        <button class="sheet-btn btn-rename" onclick="triggerRename()">ä¿®æ”¹åç§° (Rename)</button>
        <button class="sheet-btn btn-delete" onclick="confirmDelete()">åˆ é™¤ (ä¸å¯æ¢å¤)</button>
        <button class="sheet-btn btn-cancel" onclick="closeActionSheet()">å–æ¶ˆ</button>
    </div>

    <div id="data-modal" onclick="closeDataModal(event)">
        <div class="data-card">
            <div style="color:#666; font-size:12px; letter-spacing:1px">ä»Šæ—¥å®Œæˆåº¦</div>
            <div class="data-score" id="data-today-val">0%</div>
            <button class="btn" id="btn-show-history" style="margin-top:10px; width:100%" onclick="showHistory()">æŸ¥çœ‹è¿‘ä¸ƒå¤©èµ°åŠ¿</button>
            <div class="history-chart" id="history-view"></div>
        </div>
    </div>

    <script>
        const DB_KEY = 'discipline_v22';
        const WEIGHTS = { work: { weekday: 4, weekend: 2, holiday: 1 }, chore: { weekday: 2, weekend: 1, holiday: 1 }, fixed: 2 };
        const QUOTES_HIGH = ["è´¨å˜æ—¶åˆ»ï¼šä½ æ­£åœ¨é‡å¡‘å¤§è„‘å›è·¯ã€‚", "å°±æ˜¯è¿™ç§æ„Ÿè§‰ï¼Œä¿æŒä½ã€‚", "å¹³å‡¡ä¸å“è¶Šçš„åˆ†ç•Œçº¿å°±åœ¨æ­¤åˆ»ã€‚"];
        const ROASTS_LOW = ["ä½ çš„è®¡åˆ’æ˜¯å†™åœ¨æ°´ä¸Šçš„å—ï¼Ÿ", "é—´æ­‡æ€§è¸Œèº‡æ»¡å¿—ï¼ŒæŒç»­æ€§æ··åƒç­‰æ­»ã€‚", "ä»Šå¤©çš„ä½ ï¼Œé…ä¸ä¸Šæ˜å¤©çš„æ¢¦æƒ³ã€‚"];
        const ROASTS_MID = ["è¿˜åœ¨èˆ’é€‚åŒºé‡Œæ‰“è½¬ï¼Ÿ", "ä¸ç—›ä¸ç—’çš„åŠªåŠ›ï¼Œæ„ŸåŠ¨äº†è°ï¼Ÿ", "å·®ä¸€ç‚¹ï¼Œå°±æ˜¯å·®å¾ˆå¤šã€‚"];
        
        let db = {
            meta: { version: 1, lastDate: '', mode: 'weekday', target: 8, reqChores: 2, todayQuote: '' },
            pool: { work: [{id:'w1', name:'æ·±åº¦å·¥ä½œ', hidden:false}, {id:'w2', name:'ä¼šè®®', hidden:false}], chore: [{id:'c1', name:'æ¸…ç†æ¡Œé¢', hidden:false}, {id:'c2', name:'å›å¤æ¶ˆæ¯', hidden:false}] },
            today: { work: [], chores: [], fixed: {read:false, clean:false, meditate:false}, givenUp: false, stopLossStart: 0 },
            history: {}, setupComplete: false
        };
        let tempSel = { workIds: new Set(), choreIds: new Set() };
        let currentPoolTab = 'work';
        let actionTargetId = null;
        let pressTimer = null;
        let stopLossTimer = null;

        // Icons - High contrast Eye (Color Fixed to accent/gray)
        const ICON_EYE_OPEN = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        const ICON_EYE_CLOSED = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;

        window.onload = () => {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) db = JSON.parse(saved);
            checkNewDay();
            applyTheme(db.meta.mode);
            
            if(!db.setupComplete) {
                initGateway();
                const day = new Date().getDay();
                const autoMode = (day === 0 || day === 6) ? 'weekend' : 'weekday';
                setMode(autoMode, autoMode==='weekday'?8:5, autoMode==='weekday'?2:1);
            } else {
                document.getElementById('gateway-modal').classList.add('closed');
                renderMain();
                if(db.today.stopLossStart > 0) startStopLossTimer();
            }
            if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
        };

        // --- Core ---
        function checkNewDay() {
            const nowStr = new Date().toLocaleDateString();
            if(db.meta.lastDate !== nowStr) {
                if(db.meta.lastDate) { db.history[db.meta.lastDate] = calculateScore() / db.meta.target; }
                db.meta.lastDate = nowStr;
                db.today = { work: [], chores: [], fixed: {read:false, clean:false, meditate:false}, givenUp: false, stopLossStart: 0 };
                db.setupComplete = false;
                saveDB();
            }
        }
        function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function applyTheme(mode) { document.body.className = `mode-${mode}`; }
        function sanitize(str) { return str.replace(/[<>]/g, ''); }

        // --- Gateway ---
        function checkModeSelection(mode) {
            const day = new Date().getDay();
            const isWeekend = (day === 0 || day === 6);
            if (mode === 'holiday') { if(!confirm("ä»Šå¤©æ˜¯å·¥ä½œæ—¥/å‘¨æœ«ï¼Œç¡®è®¤å¼€å¯å‡æœŸæ¨¡å¼ï¼Ÿ")) return; } 
            else if (mode === 'weekend' && !isWeekend) { if(!confirm("ä»Šå¤©æ˜¯å·¥ä½œæ—¥ï¼Œç¡®è®¤å¼€å¯åŒä¼‘æ¨¡å¼ï¼Ÿ")) return; } 
            else if (mode === 'weekday' && isWeekend) { if(!confirm("ä»Šå¤©æ˜¯å‘¨æœ«ï¼Œç¡®è®¤å¼€å¯å·¥ä½œæ—¥æ¨¡å¼ï¼Ÿ")) return; }
            let t=8, r=2; if(mode==='weekend') { t=5; r=1; } if(mode==='holiday') { t=4; r=1; }
            setMode(mode, t, r);
        }

        function setMode(mode, target, req) { 
            db.meta.mode = mode; db.meta.target = target; db.meta.reqChores = req; 
            applyTheme(mode);
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-mode-${mode}`).classList.add('active');
            renderGatewayList(); 
            const btn = document.getElementById('btn-start');
            const valid = tempSel.workIds.size >= 1 && tempSel.choreIds.size >= req;
            btn.disabled = !valid; btn.style.opacity = valid ? 1 : 0.5;
        }

        function renderGatewayList() {
            const mkItem = (item, type, set) => `
                <div class="select-item ${set.has(item.id)?'selected':''}" onclick="toggleSel('${type}', '${item.id}', this)">
                    <input type="checkbox" class="select-checkbox" ${set.has(item.id)?'checked':''}>
                    <span class="${type==='work'?'font-work':''}">${item.name}</span>
                </div>`;
            document.getElementById('gateway-work-list').innerHTML = db.pool.work.filter(i=>!i.hidden).map(i => mkItem(i, 'work', tempSel.workIds)).join('');
            document.getElementById('gateway-chore-list').innerHTML = db.pool.chore.filter(i=>!i.hidden).map(i => mkItem(i, 'chore', tempSel.choreIds)).join('');
        }
        function toggleSel(type, id, el) { 
            const set = type === 'work' ? tempSel.workIds : tempSel.choreIds; 
            if(set.has(id)) set.delete(id); else set.add(id);
            setMode(db.meta.mode, db.meta.target, db.meta.reqChores); 
        }
        function confirmGateway() {
            db.today.work = db.pool.work.filter(i => tempSel.workIds.has(i.id)).map(i => ({...i, val:0, done:false}));
            db.today.chores = db.pool.chore.filter(i => tempSel.choreIds.has(i.id)).map(i => ({...i, done:false}));
            db.setupComplete = true; saveDB();
            document.getElementById('gateway-modal').classList.add('closed'); renderMain();
        }

        // --- Main ---
        function renderMain() {
            if(db.today.givenUp) document.body.style.filter = "grayscale(1)";
            const activeW = db.today.work.filter(w => !w.done);
            document.getElementById('main-work-list').innerHTML = activeW.map(w => {
                // Calculate percentage for CSS fill logic
                const pct = (w.val / 4) * 100;
                return `
                <div class="task-row work-task">
                    <div class="task-header"><span class="font-work">${w.name}</span><span>${w.val}h</span></div>
                    <div style="display:flex; gap:10px; align-items:center">
                        <input type="range" max="4" step="0.5" value="${w.val}" 
                               style="--pct: ${pct}%"
                               oninput="this.style.setProperty('--pct', (this.value/4)*100 + '%'); this.parentNode.previousElementSibling.lastElementChild.innerText=this.value+'h'"
                               onchange="updateVal('${w.id}', this.value)">
                        <button class="btn btn-primary" onclick="finishWork('${w.id}')">Done</button>
                    </div>
                </div>`
            }).join('');
            document.getElementById('empty-work').classList.toggle('hidden', activeW.length > 0);

            const activeC = db.today.chores.filter(c => !c.done);
            document.getElementById('main-chore-list').innerHTML = activeC.map(c => `
                <div class="task-row" style="display:flex; justify-content:space-between; align-items:center">
                    <span>${c.name}</span>
                    <button class="btn btn-primary" onclick="finishChore('${c.id}')">Done</button>
                </div>`).join('');
            document.getElementById('empty-chore').classList.toggle('hidden', activeC.length > 0);

            const doneW = db.today.work.filter(w => w.done);
            const doneC = db.today.chores.filter(c => c.done);
            document.getElementById('archive-count').innerText = doneW.length + doneC.length;
            document.getElementById('archive-container').innerHTML = `
                ${doneW.map(w => `<div class="archived-item"><span class="font-work">ğŸ’¼ ${w.name} (${w.val}h)</span><button class="btn btn-revive" onclick="revive('work','${w.id}')">æ’¤é”€</button></div>`).join('')}
                ${doneC.map(c => `<div class="archived-item"><span>ğŸ“ ${c.name}</span><button class="btn btn-revive" onclick="revive('chore','${c.id}')">æ’¤é”€</button></div>`).join('')}`;

            renderFixed(); updateProgress();
        }

        function updateVal(id, v) { const w = db.today.work.find(i=>i.id===id); if(w){w.val=parseFloat(v); saveDB();} }
        function finishWork(id) { const w = db.today.work.find(i=>i.id===id); if(w.val < 0.5) return alert("å·¥ä½œéœ€ >= 0.5h"); w.done = true; saveAndRender(); }
        function finishChore(id) { db.today.chores.find(i=>i.id===id).done = true; saveAndRender(); }
        function revive(t, id) { if(t==='work') db.today.work.find(i=>i.id===id).done=false; else db.today.chores.find(i=>i.id===id).done=false; saveAndRender(); }
        function renderFixed() {
            const f = db.today.fixed; const cnt = Object.values(f).filter(v=>v).length;
            ['read','clean','meditate'].forEach(k => {
                const el = document.getElementById('f-'+k); el.className = 'fixed-item';
                if(f[k]) el.classList.add('done'); else if(cnt >= 2) el.classList.add('excess');
            });
        }
        function toggleFixed(k) { if(db.today.givenUp) return; db.today.fixed[k] = !db.today.fixed[k]; saveAndRender(); }

        function calculateScore() {
            let s = 0; const mode = db.meta.mode;
            const wt = WEIGHTS.work[mode]; const ct = WEIGHTS.chore[mode];
            const aw = db.today.work.filter(w=>w.done).reduce((a,b)=>a+b.val,0); s += Math.min(aw, wt);
            const ac = db.today.chores.filter(c=>c.done).length; s += Math.min(ac, ct);
            const af = Object.values(db.today.fixed).filter(v=>v).length; s += Math.min(af, WEIGHTS.fixed);
            return s;
        }

        function updateProgress() {
            const rate = calculateScore() / db.meta.target;
            document.getElementById('progress-bar').style.width = Math.min(rate * 100, 100) + '%';
            if(rate > 0.9 && !sessionStorage.getItem('high_score_toast')) {
                showToast(QUOTES_HIGH[Math.floor(Math.random()*QUOTES_HIGH.length)]);
                sessionStorage.setItem('high_score_toast', '1');
            }
        }

        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }

        // --- Task Pool ---
        function openPoolModal() { currentPoolTab='work'; renderPoolList(); document.getElementById('pool-modal').classList.add('active'); }
        function closePoolModal() { document.getElementById('pool-modal').classList.remove('active'); if(!db.setupComplete) renderGatewayList(); }
        function switchPoolTab(type) { currentPoolTab = type; document.querySelectorAll('.pool-tab').forEach(t => t.classList.remove('active')); document.getElementById('tab-'+type).classList.add('active'); renderPoolList(); }
        
        function renderPoolList() {
            const list = db.pool[currentPoolTab];
            const isWork = currentPoolTab === 'work';
            const activeItems = list.filter(i => !i.hidden);
            const hiddenItems = list.filter(i => i.hidden);

            let html = activeItems.map((i, idx) => `
                <div class="pool-item-row" id="item-${i.id}"
                     ontouchstart="startPress('${i.id}')" ontouchend="cancelPress()" 
                     onmousedown="startPress('${i.id}')" onmouseup="cancelPress()"
                     oncontextmenu="return false;">
                    <button class="btn-icon" onclick="toggleHide('${i.id}')">${ICON_EYE_OPEN}</button>
                    <div class="pool-text ${isWork?'font-work':''}">${i.name}</div>
                    ${idx>0 ? `<button class="btn-sort" onclick="moveItem(${idx}, -1)">â†‘</button>` : ''}
                </div>`).join('');

            if (hiddenItems.length > 0) {
                html += `
                <div class="hidden-section">
                    <div class="hidden-toggle" onclick="toggleHiddenList()">â–¼ å·²éšè— (${hiddenItems.length})</div>
                    <div class="hidden-list" id="hidden-list-view">
                        ${hiddenItems.map(i => `
                            <div class="pool-item-row hidden-item">
                                <button class="btn-icon" onclick="toggleHide('${i.id}')">${ICON_EYE_CLOSED}</button>
                                <div>${i.name}</div>
                            </div>`).join('')}
                    </div>
                </div>`;
            }
            document.getElementById('pool-list-container').innerHTML = html;
        }

        function toggleHiddenList() { document.getElementById('hidden-list-view').classList.toggle('open'); }
        function addNewToPool() {
            const val = document.getElementById('pool-input').value.trim();
            if(val) { db.pool[currentPoolTab].push({id: currentPoolTab[0]+Date.now(), name: sanitize(val), hidden: false}); document.getElementById('pool-input').value = ''; saveDB(); renderPoolList(); }
        }
        function moveItem(idx, dir) {
            const arr = db.pool[currentPoolTab];
            const activeList = arr.filter(i=>!i.hidden);
            const item = activeList[idx]; const target = activeList[idx+dir];
            if(item && target) {
                const r1 = arr.indexOf(item); const r2 = arr.indexOf(target);
                [arr[r1], arr[r2]] = [arr[r2], arr[r1]];
                saveDB(); renderPoolList();
            }
        }
        function toggleHide(id) { const item = db.pool[currentPoolTab].find(i=>i.id===id); if(item) { item.hidden = !item.hidden; saveDB(); renderPoolList(); } }

        function triggerRename() {
            closeActionSheet();
            const item = db.pool[currentPoolTab].find(i=>i.id===actionTargetId);
            if (!item) return;
            const newName = prompt("ä¿®æ”¹åç§°ï¼š", item.name);
            if (newName && newName.trim() !== "") { item.name = sanitize(newName.trim()); saveDB(); renderPoolList(); }
        }

        // Action Sheet
        function startPress(id) { 
            pressTimer = setTimeout(() => { 
                actionTargetId = id; 
                if(navigator.vibrate) navigator.vibrate(50); 
                document.getElementById('action-sheet').classList.add('active'); 
                document.getElementById('sheet-overlay').classList.add('active'); 
            }, 600); 
        }
        function cancelPress() { clearTimeout(pressTimer); }
        function closeActionSheet() { document.getElementById('action-sheet').classList.remove('active'); document.getElementById('sheet-overlay').classList.remove('active'); }
        function confirmDelete() { db.pool[currentPoolTab] = db.pool[currentPoolTab].filter(i=>i.id!==actionTargetId); saveDB(); renderPoolList(); closeActionSheet(); }

        // Stop Loss
        function handleStopLoss() {
            if (db.today.givenUp) return;
            const btn = document.getElementById('btn-giveup');
            if (db.today.stopLossStart === 0) {
                db.today.stopLossStart = Date.now(); saveDB(); updateStopLossBtn(); startStopLossTimer(); return;
            }
            if (Date.now() - db.today.stopLossStart < 30 * 60 * 1000) {
                if(confirm("æ’¤é”€â€œæ­¢æŸâ€ï¼Ÿ\nå›åˆ°æ­£å¸¸çŠ¶æ€ã€‚")) { db.today.stopLossStart = 0; saveDB(); clearInterval(stopLossTimer); btn.innerText = "æ­¢æŸ"; btn.style.borderColor = "#333"; btn.style.color = "var(--danger)"; } return;
            }
            if(confirm("ç¡®è®¤æ”¾å¼ƒä»Šæ—¥ï¼Ÿ\nä¸è®¡åˆ†ï¼Œå±å¹•å˜ç°ã€‚")) { db.today.givenUp = true; db.today.stopLossStart = 0; clearInterval(stopLossTimer); saveAndRender(); }
        }
        function updateStopLossBtn() {
            const btn = document.getElementById('btn-giveup');
            const remaining = 30 * 60 * 1000 - (Date.now() - db.today.stopLossStart);
            if (remaining > 0) {
                const mm = Math.floor(remaining / 60000); const ss = Math.floor((remaining % 60000) / 1000);
                btn.innerText = `æ’¤é”€ (${mm}:${ss<10?'0'+ss:ss})`; btn.style.color = "#888"; btn.style.borderColor = "#888";
            } else { btn.innerText = "ç¡®è®¤æ”¾å¼ƒ"; btn.style.color = "var(--danger)"; btn.style.borderColor = "var(--danger)"; }
        }
        function startStopLossTimer() {
            if(stopLossTimer) clearInterval(stopLossTimer);
            updateStopLossBtn();
            stopLossTimer = setInterval(updateStopLossBtn, 1000);
        }

        // Data Modal
        function openDataModal() {
            const rate = Math.round((calculateScore()/db.meta.target)*100);
            document.getElementById('data-today-val').innerText = rate + '%';
            document.getElementById('data-modal').classList.add('active');
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('btn-show-history').style.display = 'block';
        }
        function closeDataModal(e) { if(e.target.id==='data-modal') document.getElementById('data-modal').classList.remove('active'); }
        function showHistory() {
            document.getElementById('btn-show-history').style.display = 'none';
            const hv = document.getElementById('history-view'); hv.style.display = 'block';
            const dates = Object.keys(db.history).sort().slice(-7);
            if(dates.length === 0) { hv.innerHTML = '<div style="color:#666">æš‚æ— å†å²æ•°æ®</div>'; return; }
            let totalRate = 0;
            let html = dates.map(d => {
                const r = db.history[d]; totalRate += r; const rPct = Math.round(r*100);
                return `<div class="history-row"><span>${d.slice(5)}</span><div style="display:flex;align-items:center;gap:10px"><div class="bar-bg"><div class="bar-fill" style="width:${rPct}%"></div></div><span style="width:30px;text-align:right">${rPct}%</span></div></div>`;
            }).join('');
            const avg = totalRate / dates.length;
            let roast = "";
            if (avg < 0.4) roast = ROASTS_LOW[Math.floor(Math.random()*ROASTS_LOW.length)];
            else if (avg < 0.7) roast = ROASTS_MID[Math.floor(Math.random()*ROASTS_MID.length)];
            if (roast) html += `<div class="roast-text">â€œ${roast}â€</div>`;
            hv.innerHTML = html;
        }

        function toggleArchive() { document.getElementById('archive-container').classList.toggle('open'); }
        function saveAndRender() { saveDB(); renderMain(); }
    </script>
</body>
</html>